name: Deploy Dev Branch to /dev

on:
  push:
    branches:
      - dev

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main
      
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          path: dev-branch
      
      - name: Prepare dev files
        run: |
          # Remove old dev directory if it exists
          rm -rf main/dev
          
          # Create dev directory
          mkdir -p main/dev
          
          # Copy all files from dev branch to main/dev
          # Exclude .git directory
          rsync -av --exclude='.git' --exclude='.github' dev-branch/ main/dev/
          
          # Add dev banner to all HTML files
          for file in main/dev/*.html; do
            if [ -f "$file" ]; then
              # Add [DEV] prefix to title
              sed -i 's/<title>\(.*\)<\/title>/<title>[DEV] \1<\/title>/' "$file"
              
              # Add dev banner after <body> tag
              sed -i 's/<body>/<body>\n    <!-- DEV MODE BANNER -->\n    <div class="dev-banner">\n        ðŸš§ DEV MODE - <a href="..\/index.html">Go to Production<\/a>\n    <\/div>/' "$file"
            fi
          done
          
          # Add dev banner styles to CSS file if it exists
          if [ -f "main/dev/css/styles.css" ]; then
            cat >> main/dev/css/styles.css << 'EOF'

/* Dev Banner Styles */
.dev-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(90deg, #ff6b6b, #ffa500);
    color: white;
    text-align: center;
    padding: 8px;
    font-weight: bold;
    z-index: 9999;
    font-size: 14px;
}

.dev-banner a {
    color: white;
    text-decoration: underline;
    margin-left: 10px;
}

body {
    padding-top: 40px !important;
}

.navbar {
    top: 40px !important;
}
EOF
          fi
      
      - name: Commit and push changes
        run: |
          cd main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dev/
          git diff --staged --quiet || git commit -m "Deploy dev branch to /dev [automated]"
          git push
