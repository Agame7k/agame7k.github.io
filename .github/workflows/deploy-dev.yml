name: Deploy Dev Branch to /dev

on:
  push:
    branches:
      - dev
  workflow_dispatch:  # Allow manual triggering from GitHub UI

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main
      
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          path: dev-branch
      
      - name: Prepare dev files
        run: |
          # Remove old dev directory if it exists
          rm -rf main/dev
          
          # Create dev directory
          mkdir -p main/dev
          
          # Copy all files from dev branch to main/dev
          # Exclude .git directory and common development artifacts
          rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='.DS_Store' --exclude='*.log' dev-branch/ main/dev/
          
          # Add dev banner to all HTML files if any exist
          shopt -s nullglob
          html_files=(main/dev/*.html)
          if [ ${#html_files[@]} -gt 0 ]; then
            for file in "${html_files[@]}"; do
              # Add [DEV] prefix to title (handles multi-line and complex titles)
              perl -0777 -i -pe 's{(<title[^>]*>)(.*?)(</title>)}{ $2 =~ /^\[DEV\]/ ? "$1$2$3" : "$1[DEV] $2$3" }egs' "$file" || true
              
              # Add dev banner after <body> tag (handles body tag with or without attributes)
              sed -i 's/<body\([^>]*\)>/<body\1>\n    <!-- DEV MODE BANNER -->\n    <div class="dev-banner">\n        ðŸš§ DEV MODE - <a href="\/">Go to Production<\/a>\n    <\/div>/' "$file" || true
            done
          fi
      
      - name: Create dev banner CSS
        run: |
          mkdir -p main/dev/css
          # Using a unique filename (.dev-banner-auto.css) to avoid overwriting user files
          cat > main/dev/css/.dev-banner-auto.css << 'DEVBANNERCSS'
          /* Dev Banner Styles - Auto-generated */
          .dev-banner {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: linear-gradient(90deg, #ff6b6b, #ffa500);
              color: white;
              text-align: center;
              padding: 8px;
              font-weight: bold;
              z-index: 9999;
              font-size: 14px;
          }

          .dev-banner a {
              color: white;
              text-decoration: underline;
              margin-left: 10px;
          }

          /* Offset body content for fixed banner */
          body {
              margin-top: 36px;
          }
          DEVBANNERCSS
      
      - name: Add CSS link to HTML files
        run: |
          shopt -s nullglob
          html_files=(main/dev/*.html)
          if [ ${#html_files[@]} -gt 0 ]; then
            for file in "${html_files[@]}"; do
              # Add .dev-banner-auto.css link before </head> (uses hidden filename to avoid overwrites)
              sed -i 's/<\/head>/    <link rel="stylesheet" href="css\/.dev-banner-auto.css">\n<\/head>/' "$file" || true
            done
          fi
      
      - name: Commit and push changes
        run: |
          cd main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dev/
          git diff --staged --quiet || git commit -m "Deploy dev branch to /dev [automated]"
          git push
